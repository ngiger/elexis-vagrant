#!/usr/bin/env ruby
#
# Copyright (c) Niklaus Giger niklaus.giger@member.fsf.org
#
# Simple test script for the elexis-vagrant project to import
# the elexis database into the tst_db. Should be run e.g. each week
$: << File.dirname( __FILE__)
require 'pg_util.rb'

<%= scope.function_include(['elexis::postgresql_server']) %>
pg_main_db_name      = '<%=  scope.function_hiera(['elexis::pg_main_db_name',     'elexis']) %>'
pg_main_db_user      = '<%=  scope.function_hiera(['elexis::pg_main_db_user',     'elexis']) %>'
pg_main_db_password  = '<%=  scope.function_hiera(['elexis::pg_main_db_password', 'elexisTest']) %>'
pg_tst_db_name       = '<%=  scope.function_hiera(['elexis::pg_tst_db_name' ,     'test']) %>'
pg_dump_dir          = '<%=  scope.function_hiera(['elexis::pg_dump_dir',         '/home/backup-pg']) %>'

ENV['PGPASSWORD'] = pg_main_db_password
dump   = "#{pg_dump_dir}/#{pg_main_db_name}.dump.gz"
puts ARGV.inspect
dump = ARGV[0] if ARGV.size > 0

cmd  = "gunzip --to-stdout #{dump} | "
cmd += "psql --user elexis --host localhost --dbname=#{pg_tst_db_name}"

system(cmd)
logAction("load of #{pg_main_db_name} via #{dump} into #{pg_tst_db_name} finished")
