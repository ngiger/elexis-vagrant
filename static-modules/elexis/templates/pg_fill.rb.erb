#!/usr/bin/env ruby
#
# Copyright (c) Niklaus Giger niklaus.giger@member.fsf.org
#
# Simple test script for the elexis-vagrant project to fill a dummy table
$: << File.dirname( __FILE__)
require 'pg_util.rb'
<%= scope.function_include(['elexis::postgresql_server']) %>
pg_main_db_name      = '<%=  scope.function_hiera(['elexis::postgresql_server::pg_main_db_name',     'elexis']) %>'
pg_main_db_user      = '<%=  scope.function_hiera(['elexis::postgresql_server::pg_main_db_user',     'elexis']) %>'
pg_main_db_password  = '<%=  scope.function_hiera(['elexis::postgresql_server::pg_main_db_password', 'elexisTest']) %>'
pg_tst_db_name       = '<%=  scope.function_hiera(['elexis::postgresql_server::pg_tst_db_name',      'tst_db']) %>'
pg_dump_dir          = '<%=  scope.function_hiera(['elexis::postgresql_server::pg_dump_dir',         '/home/backup-pg']) %>'

ENV['PGPASSWORD'] = pg_main_db_password
loops = 0;
psqlStart = "psql --user #{pg_main_db_user} --host localhost #{pg_main_db_name}"

system("#{psqlStart} --version")
system("#{psqlStart} --command='\\d'")
system("#{psqlStart} --command='create table if not exists tmp_fill  (data varchar(255) );'")
while true
  loops += 1
  puts "#{__FILE__}: I am in  loop #{loops}"
  system("#{psqlStart} --command=\"insert into tmp_fill values ( \'dummy value #{Time.now}\' );\"")
  system("#{psqlStart} --command='select count(*), max(data) from tmp_fill;'")
  exit if loops > 3 and $VERBOSE
  sleep 7
end
